/**
 * Supabase Edge Function: analyze-video (STAGING VERSION)
 *
 * IMPORTANT: Copy this ENTIRE file into the Supabase Dashboard
 *
 * This version saves analysis results to video_analysis_sessions table
 * instead of directly to exercise_cards. Users review and import via UI.
 *
 * Steps to deploy:
 * 1. Run migration 003_add_video_staging.sql first
 * 2. Go to: https://supabase.com/dashboard/project/xaknhwxfkcxtqjkwkccn/functions
 * 3. Click on "analyze-video" function
 * 4. Click "Code" tab
 * 5. Select ALL existing code and DELETE it
 * 6. Paste THIS ENTIRE FILE
 * 7. Click "Deploy"
 */

import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

interface GeminiExercise {
  name: string
  start_time: string
  end_time: string
  instructions: string[]
  coaching_cues: string[]
  screenshot_timestamps: string[]
  difficulty: 'beginner' | 'intermediate' | 'advanced'
  equipment: string[]
}

interface GeminiAnalysisResponse {
  video_title: string
  sport?: string
  total_duration: string
  exercises: GeminiExercise[]
}

async function analyzeVideoWithGemini(
  videoUrl: string,
  geminiApiKey: string,
  sport?: string
): Promise<GeminiAnalysisResponse> {
  const prompt = buildAnalysisPrompt(sport)

  const requestBody = {
    contents: [
      {
        parts: [
          {
            text: prompt
          },
          {
            fileData: {
              fileUri: videoUrl
            }
          }
        ]
      }
    ],
    generationConfig: {
      temperature: 0.2,
      responseMimeType: "application/json"
    }
  }

  const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`,
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-goog-api-key': geminiApiKey
      },
      body: JSON.stringify(requestBody)
    }
  )

  if (!response.ok) {
    const errorText = await response.text()
    throw new Error(`Gemini API error (${response.status}): ${errorText}`)
  }

  const data = await response.json()
  const jsonText = data.candidates?.[0]?.content?.parts?.[0]?.text
  if (!jsonText) {
    throw new Error('No content returned from Gemini API')
  }

  const cleanedJson = jsonText
    .replace(/```json\n?/g, '')
    .replace(/```\n?/g, '')
    .trim()

  return JSON.parse(cleanedJson)
}

function buildAnalysisPrompt(sport?: string): string {
  const sportContext = sport ? `This is a ${sport} training video.` : ''

  return `Analyze this exercise or athletic drill video. Provide a structured analysis.

${sportContext}

TASKS:
1. If the video contains MULTIPLE exercises, segment them with timestamps
2. For EACH exercise provide:
   - Exercise name
   - Start time (MM:SS)
   - End time (MM:SS)
   - Step-by-step instructions (3-5 steps, clear and concise)
   - Key coaching cues (2-3 tips)
   - Screenshot timestamps - identify 2-4 moments that best show proper form
   - Difficulty: beginner, intermediate, or advanced
   - Equipment needed

OUTPUT as valid JSON:
{
  "video_title": "string",
  "sport": "string",
  "total_duration": "MM:SS",
  "exercises": [
    {
      "name": "string",
      "start_time": "MM:SS",
      "end_time": "MM:SS",
      "instructions": ["step 1", "step 2"],
      "coaching_cues": ["cue 1", "cue 2"],
      "screenshot_timestamps": ["MM:SS", "MM:SS"],
      "difficulty": "string",
      "equipment": ["item1"]
    }
  ]
}

Respond ONLY with the JSON, no other text.`
}

async function createAnalysisSession(
  supabase: any,
  videoUrl: string,
  analysis: GeminiAnalysisResponse
): Promise<any> {
  const { data, error } = await supabase
    .from('video_analysis_sessions')
    .insert({
      video_url: videoUrl,
      video_title: analysis.video_title,
      sport: analysis.sport,
      total_duration: analysis.total_duration,
      analysis_result: analysis,
      status: 'pending'
    })
    .select()
    .single()

  if (error) throw error
  return data
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const { videoUrl, sport } = await req.json()

    if (!videoUrl) {
      return new Response(
        JSON.stringify({ error: 'videoUrl is required' }),
        {
          status: 400,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      )
    }

    const isYouTube = /^https?:\/\/(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)[\w-]+/.test(videoUrl)
    if (!isYouTube) {
      return new Response(
        JSON.stringify({
          error: 'Only YouTube URLs are currently supported',
          hint: 'Format: https://youtube.com/watch?v=VIDEO_ID or https://youtu.be/VIDEO_ID'
        }),
        {
          status: 400,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        }
      )
    }

    const geminiApiKey = Deno.env.get('GEMINI_API_KEY')
    if (!geminiApiKey) {
      throw new Error('GEMINI_API_KEY not configured in Edge Function secrets')
    }

    const supabaseUrl = Deno.env.get('SUPABASE_URL')!
    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    const supabase = createClient(supabaseUrl, supabaseServiceKey)

    console.log(`Analyzing video: ${videoUrl}`)
    const analysis = await analyzeVideoWithGemini(videoUrl, geminiApiKey, sport)
    console.log(`Found ${analysis.exercises.length} exercises`)

    console.log('Creating analysis session...')
    const session = await createAnalysisSession(supabase, videoUrl, analysis)
    console.log(`Session created: ${session.id}`)

    return new Response(
      JSON.stringify({
        success: true,
        sessionId: session.id,
        analysis: {
          video_title: analysis.video_title,
          sport: analysis.sport,
          total_duration: analysis.total_duration,
          exercise_count: analysis.exercises.length
        },
        exercises: analysis.exercises.map(e => ({
          name: e.name,
          difficulty: e.difficulty,
          equipment: e.equipment,
          start_time: e.start_time,
          end_time: e.end_time
        }))
      }),
      {
        status: 200,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    )

  } catch (error) {
    console.error('Error in analyze-video function:', error)

    return new Response(
      JSON.stringify({
        error: error.message,
        details: error.stack
      }),
      {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      }
    )
  }
})
